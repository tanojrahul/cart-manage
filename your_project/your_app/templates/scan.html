{% extends 'base.html' %}

{% block title %}Scan Products{% endblock %}

{% block content %}
<div id="qr-reader" style="width: 100%;"></div>
<div id="qr-reader-results" style="margin-top: 20px;"></div>

<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
    function onScanSuccess(decodedText, decodedResult) {
        // Display the scanned QR code result
        document.getElementById('qr-reader-results').innerText = `Scanned Product ID: ${decodedText}`;

        // Send the product ID to the server to add the product to the cart
        fetch("{% url 'scan' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: new URLSearchParams({
                'product_id': decodedText  // Pass the scanned product ID
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Product added to cart!");
            } else {
                alert("Failed to add product to cart.");
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("An error occurred while adding the product to the cart.");
        });
    }

    // Initialize the QR code scanner
    var html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess);
</script>
{% endblock %}
